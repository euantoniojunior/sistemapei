<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Vers√£o do PEI</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f4f7fa;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 900px;
            margin: 40px auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }

        h2 {
            color: #003D7C;
            text-align: center;
            margin-bottom: 20px;
        }

        .dados strong {
            display: block;
            margin-bottom: 5px;
            color: #333;
        }

        .metas table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .metas th, .metas td {
            border: 1px solid #ccc;
            padding: 10px;
            text-align: left;
        }

        .assinatura {
            display: flex;
            justify-content: space-between;
            margin-top: 40px;
            font-size: 14px;
        }

        .assinatura div {
            width: 24%;
            text-align: center;
        }

        .actions {
            text-align: center;
            margin-top: 40px;
        }

        .btn-imprimir,
        .btn-exportar,
        .btn-voltar {
            background-color: #003D7C;
            color: white;
            border: none;
            padding: 10px 16px;
            font-size: 14px;
            border-radius: 6px;
            cursor: pointer;
            margin: 0 5px;
        }

        .btn-imprimir:hover,
        .btn-exportar:hover,
        .btn-voltar:hover {
            background-color: #002a54;
        }
    </style>
</head>
<body>

<div class="container">
    <h2>Vers√£o do PEI</h2>

    <!-- Dados do Aluno -->
    <div class="dados" id="dados-aluno">
        <h3>Dados do Aluno</h3>
        <strong>ID:</strong> <span id="aluno-id"></span><br>
        <strong>Nome:</strong> <span id="aluno-nome"></span><br>
        <strong>Curso:</strong> <span id="aluno-curso"></span><br>
        <strong>Unidade:</strong> <span id="aluno-unidade"></span><br>
        <strong>Per√≠odo Letivo:</strong> <span id="aluno-periodo"></span><br>
        <strong>Data de Elabora√ß√£o:</strong> <span id="aluno-data_elaboracao"></span><br>
        <strong>Respons√°vel:</strong> <span id="aluno-responsavel"></span><br>
        <strong>Data de Nascimento:</strong> <span id="aluno-data_nascimento"></span><br>
        <strong>Idade:</strong> <span id="aluno-idade"></span><br>
        <strong>Diagn√≥stico CID:</strong> <span id="aluno-diagnostico_cid"></span><br>
        <strong>Transtorno Identificado:</strong> <span id="aluno-transtorno_identificado"></span><br>
        <strong>Laudo M√©dico:</strong> <span id="aluno-laudo_medico"></span><br>
        <strong>Psic√≥logo:</strong> <span id="aluno-psicologo"></span><br>
        <strong>Psiquiatra:</strong> <span id="aluno-psiquiatra"></span><br>
        <strong>Psicopedagogo:</strong> <span id="aluno-psicopedagogo"></span><br>
        <strong>Outros Profissionais:</strong> <span id="aluno-outros_profissionais"></span><br>
        <strong>Perfil do Aluno:</strong> <span id="aluno-perfil_aluno"></span><br>
        <strong>Observa√ß√µes Gerais:</strong> <span id="aluno-observacoes_gerais"></span><br>
        <strong>Pr√≥xima Avalia√ß√£o:</strong> <span id="aluno-proxima_avaliacao"></span><br>
    </div>

    <div class="dados" id="dados-peis">
        <h3>Conte√∫do do PEI</h3>
        <strong>Objetivos Gerais:</strong> <span id="conteudo-objetivos_gerais"></span><br>
        <strong>Adapta√ß√µes Pedag√≥gicas:</strong> <span id="conteudo-adapta√ßoes_pedagogicas"></span><br>
        <strong>Interven√ß√µes Complementares:</strong> <span id="conteudo-intervencoes_complementares"></span><br>

        <h3>Metas Individuais</h3>
        <table class="metas">
            <tr>
                <th>M√©todo</th>
                <th>Meta</th>
                <th>Respons√°vel</th>
                <th>Avalia√ß√£o</th>
            </tr>
            <tr>
                <td>Curto prazo</td>
                <td><span id="curto-meta"></span></td>
                <td><span id="curto-responsavel"></span></td>
                <td><span id="curto-avaliacao"></span></td>
            </tr>
            <tr>
                <td>M√©dio prazo</td>
                <td><span id="medio-meta"></span></td>
                <td><span id="medio-responsavel"></span></td>
                <td><span id="medio-avaliacao"></span></td>
            </tr>
            <tr>
                <td>Longo prazo</td>
                <td><span id="longo-meta"></span></td>
                <td><span id="longo-responsavel"></span></td>
                <td><span id="longo-avaliacao"></span></td>
            </tr>
        </table>
    </div>

    <div class="assinatura">
        <div>
            <strong>Respons√°vel Legal</strong><br>
            __________________________<br>
            <span id="aluno-responsavel_legal"></span>
        </div>
        <div>
            <strong>Orientador Respons√°vel</strong><br>
            __________________________<br>
            <span id="aluno-orientador_responsavel"></span>
        </div>
        <div>
            <strong>Supervisor</strong><br>
            __________________________<br>
            <span id="aluno-supervisor"></span>
        </div>
        <div>
            <strong>Gerente da Unidade</strong><br>
            __________________________<br>
            <span id="aluno-gerente_unidade"></span>
        </div>
    </div>

    <div class="actions">
        <button class="btn-imprimir" onclick="window.print()">üñ®Ô∏è Imprimir</button>
        <button class="btn-exportar" onclick="exportarPDF()">üìÑ Exportar PDF</button>
        <button class="btn-voltar" onclick="window.history.back()">‚Ü©Ô∏è Voltar</button>
    </div>
</div>

<script>
    async function exportarPDF() {
        const aluno = {
            id: document.getElementById("aluno-id").textContent,
            nome: document.getElementById("aluno-nome").textContent,
            curso: document.getElementById("aluno-curso").textContent,
            unidade: document.getElementById("aluno-unidade").textContent,
            periodo: document.getElementById("aluno-periodo").textContent,
            data_elaboracao: document.getElementById("aluno-data_elaboracao").textContent,
            responsavel: document.getElementById("aluno-responsavel").textContent,
            data_nascimento: document.getElementById("aluno-data_nascimento").textContent,
            idade: document.getElementById("aluno-idade").textContent,
            diagnostico_cid: document.getElementById("aluno-diagnostico_cid").textContent,
            transtorno_identificado: document.getElementById("aluno-transtorno_identificado").textContent,
            laudo_medico: document.getElementById("aluno-laudo_medico").textContent,
            psicologo: document.getElementById("aluno-psicologo").textContent,
            psiquiatra: document.getElementById("aluno-psiquiatra").textContent,
            psicopedagogo: document.getElementById("aluno-psicopedagogo").textContent,
            outros_profissionais: document.getElementById("aluno-outros_profissionais").textContent,
            perfil_aluno: document.getElementById("aluno-perfil_aluno").textContent,
            observacoes_gerais: document.getElementById("aluno-observacoes_gerais").textContent,
            proxima_avaliacao: document.getElementById("aluno-proxima_avaliacao").textContent,
            responsavel_legal: document.getElementById("aluno-responsavel_legal").textContent,
            orientador_responsavel: document.getElementById("aluno-orientador_responsavel").textContent,
            supervisor: document.getElementById("aluno-supervisor").textContent,
            gerente_unidade: document.getElementById("aluno-gerente_unidade").textContent
        };

        const conteudo = {
            objetivos_gerais: document.getElementById("conteudo-objetivos_gerais").textContent,
            adapta√ßoes_pedagogicas: document.getElementById("conteudo-adapta√ßoes_pedagogicas").textContent,
            intervencoes_complementares: document.getElementById("conteudo-intervencoes_complementares").textContent,
            metas: {
                curto_prazo: {
                    meta: document.getElementById("curto-meta").textContent,
                    responsavel: document.getElementById("curto-responsavel").textContent,
                    avaliacao: document.getElementById("curto-avaliacao").textContent
                },
                medio_prazo: {
                    meta: document.getElementById("medio-meta").textContent,
                    responsavel: document.getElementById("medio-responsavel").textContent,
                    avaliacao: document.getElementById("medio-avaliacao").textContent
                },
                longo_prazo: {
                    meta: document.getElementById("longo-meta").textContent,
                    responsavel: document.getElementById("longo-responsavel").textContent,
                    avaliacao: document.getElementById("longo-avaliacao").textContent
                }
            }
        };

        try {
            const res = await fetch('/api/pei/pdf', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ aluno, conteudo })
            });

            if (res.ok) {
                const blob = await res.blob();
                const link = document.createElement('a');
                link.href = window.URL.createObjectURL(blob);
                link.download = 'pei_historico.pdf';
                link.click();
            } else {
                alert("‚ùå Erro ao gerar PDF");
            }
        } catch (err) {
            console.error("Erro ao exportar PDF:", err);
            alert("‚ùå Erro ao exportar para PDF.");
        }
    }

    // Carrega os dados ao acessar a p√°gina
    window.onload = async () => {
        const urlParams = new URLSearchParams(window.location.search);
        const history_id = urlParams.get('history_id');

        if (!history_id) {
            document.body.innerHTML = "<h2 style='text-align:center; margin-top: 40px;'>‚ö†Ô∏è ID de hist√≥rico ausente.</h2>";
            return;
        }

        try {
            const res = await fetch(`/api/pei/historico/versao/${history_id}`);
            const data = await res.json();

            if (!res.ok || !data.aluno || !data.conteudo) {
                throw new Error(data.error || "Dados inv√°lidos retornados");
            }

            const aluno = data.aluno;
            const conteudo = data.conteudo;

            // Preenche os dados do aluno
            document.getElementById("aluno-id").textContent = aluno.id;
            document.getElementById("aluno-nome").textContent = aluno.nome;
            document.getElementById("aluno-curso").textContent = aluno.curso;
            document.getElementById("aluno-unidade").textContent = aluno.unidade;
            document.getElementById("aluno-periodo").textContent = aluno.periodo;
            document.getElementById("aluno-data_elaboracao").textContent = aluno.data_elaboracao ? new Date(aluno.data_elaboracao).toLocaleDateString() : "N/A";
            document.getElementById("aluno-responsavel").textContent = aluno.responsavel;
            document.getElementById("aluno-data_nascimento").textContent = aluno.data_nascimento ? new Date(aluno.data_nascimento).toLocaleDateString() : "N/A";
            document.getElementById("aluno-idade").textContent = aluno.idade;
            document.getElementById("aluno-diagnostico_cid").textContent = aluno.diagnostico_cid;
            document.getElementById("aluno-transtorno_identificado").textContent = aluno.transtorno_identificado;
            document.getElementById("aluno-laudo_medico").textContent = aluno.laudo_medico;
            document.getElementById("aluno-psicologo").textContent = aluno.psicologo;
            document.getElementById("aluno-psiquiatra").textContent = aluno.psiquiatra;
            document.getElementById("aluno-psicopedagogo").textContent = aluno.psicopedagogo;
            document.getElementById("aluno-outros_profissionais").textContent = aluno.outros_profissionais;
            document.getElementById("aluno-perfil_aluno").textContent = aluno.perfil_aluno;
            document.getElementById("aluno-observacoes_gerais").textContent = aluno.observacoes_gerais;
            document.getElementById("aluno-proxima_avaliacao").textContent = aluno.proxima_avaliacao ? new Date(aluno.proxima_avaliacao).toLocaleDateString() : "N/A";
            document.getElementById("aluno-responsavel_legal").textContent = aluno.responsavel_legal;
            document.getElementById("aluno-orientador_responsavel").textContent = aluno.orientador_responsavel;
            document.getElementById("aluno-supervisor").textContent = aluno.supervisor;
            document.getElementById("aluno-gerente_unidade").textContent = aluno.gerente_unidade;

            // Metas
            document.getElementById("curto-meta").textContent = conteudo.metas?.curto_prazo?.meta || "N/A";
            document.getElementById("curto-responsavel").textContent = conteudo.metas?.curto_prazo?.responsavel || "N/A";
            document.getElementById("curto-avaliacao").textContent = conteudo.metas?.curto_prazo?.avaliacao || "N/A";

            document.getElementById("medio-meta").textContent = conteudo.metas?.medio_prazo?.meta || "N/A";
            document.getElementById("medio-responsavel").textContent = conteudo.metas?.medio_prazo?.responsavel || "N/A";
            document.getElementById("medio-avaliacao").textContent = conteudo.metas?.medio_prazo?.avaliacao || "N/A";

            document.getElementById("longo-meta").textContent = conteudo.metas?.longo_prazo?.meta || "N/A";
            document.getElementById("longo-responsavel").textContent = conteudo.metas?.longo_prazo?.responsavel || "N/A";
            document.getElementById("longo-avaliacao").textContent = conteudo.metas?.longo_prazo?.avaliacao || "N/A";

            document.getElementById("conteudo-objetivos_gerais").textContent = conteudo.objetivos_gerais || "N/A";
            document.getElementById("conteudo-adapta√ßoes_pedagogicas").textContent = conteudo.adapta√ßoes_pedagogicas || "N/A";
            document.getElementById("conteudo-intervencoes_complementares").textContent = conteudo.intervencoes_complementares || "N/A";

        } catch (err) {
            document.body.innerHTML = `<h2 style='color:red;'>‚ùå Erro ao carregar vers√£o: ${err.message}</h2>`;
            console.error("Erro ao carregar vers√£o:", err);
        }
    };
</script>
</body>
</html>
